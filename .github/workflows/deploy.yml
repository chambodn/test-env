name: Deploy in environment

on:
  workflow_call:
    inputs:
      execution_environment:
        required: true
        type: string

jobs:
  check-status:
    name: check-status
    runs-on: ubuntu-latest
    steps:
      - run: echo "Targent env ${{ inputs.execution_environment }}"
      - name: Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v3

      - name: Checkout
        if: github.event_name == 'issue_comment'
        run: hub pr checkout ${{ github.event.issue.number }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: dorny/paths-filter@v2
        id: changes
        with:
          list-files: shell
          filters: |
            sandbox:
              - 'live/sandbox/**'
            dev:
              - 'live/dev/**'
            pre:
              - 'live/pre/**'
            prod:
              - 'live/prod/**'
            envcommon:
              - '_envcommon/**'
      
      - name: Check changed files
        if: |
          (steps.changes.outputs.sandbox == 'true' && inputs.execution_environment != 'sandbox') ||
          (steps.changes.outputs.dev == 'true' && inputs.execution_environment != 'dev') ||
          (steps.changes.outputs.pre == 'true' && inputs.execution_environment != 'pre') ||
          (steps.changes.outputs.prod == 'true' && inputs.execution_environment != 'prod')
        run: |
          echo "Be careful you are updated files targeting ${{ steps.changes.outputs.sandbox_files }}"
  
      - name: Check changed files
        uses: actions/github-script@v3
        if: |
          (steps.changes.outputs.sandbox == 'true' && inputs.execution_environment != 'sandbox') ||
          (steps.changes.outputs.dev == 'true' && inputs.execution_environment != 'dev') ||
          (steps.changes.outputs.pre == 'true' && inputs.execution_environment != 'pre') ||
          (steps.changes.outputs.prod == 'true' && inputs.execution_environment != 'prod')
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùåüö´ **You are trying to update files located in a different environment than the environment you are targeting!** 
                Please check the following file(s): 
                ${{ steps.changes.outputs.sandbox_files }}
              `
            });
            core.setFailed('You are trying to update files located in a different environment than the environment you are targeting');
  deploy:
    name: deploy
    needs: check-status
    environment: ${{ inputs.execution_environment }}
    runs-on: ubuntu-latest
    steps:
      - run: echo "Deploy"
